<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>1Drop YaadVibe â€” Booking</title>

  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.4.4/lib/qrcode.min.js"></script>

  <!-- TonConnect v3 UI + SDK -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Changa+One&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:#000 url('/IMG_0039.jpeg') center/cover no-repeat fixed;
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
    }

    /* overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(1px);z-index:1;pointer-events:none}

    /* flag */
    .flag{
      position:fixed;
      top:12px;
      left:12px;
      width:110px;
      height:74px;
      background:url('/IMG_0454.png') center/cover no-repeat;
      border-radius:6px;
      z-index:1002;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
      animation:waveFlow 3s ease-in-out infinite;
    }
    .flag::after{
      content:"1Drop";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:1.2rem;
      color:#fff;
      text-shadow:0 0 8px #000;
      pointer-events:none;
    }
    @keyframes waveFlow{0%,100%{transform:rotate(0) scale(1)}50%{transform:rotate(2.5deg) scale(1.03)}}

    /* tip icon â€” moved under flag */
    #btnTip {
      position:fixed;
      top:100px; /* under the flag */
      left:20px;
      z-index:1002;
      width:64px;
      height:64px;
      border-radius:50%;
      border:3px solid #FFEA9E;
      background:linear-gradient(135deg,#004d40,#006400);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.6rem;
      box-shadow:0 8px 26px rgba(0,0,0,0.6);
      cursor:pointer;
    }

    /* container */
    .container{
      position:relative;
      z-index:2;
      max-width:480px;
      margin:0 auto;
      padding:1rem;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      pointer-events:auto;
    }

    /* top controls: back + wallet stacked */
    .top-controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:8px;
      margin-bottom:8px;
    }
    .top-left {
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-start;
      width:100%;
    }
    .back-global {
      display:flex;
      align-items:center;
      gap:8px;
      background:transparent;
      border:none;
      color:#FFD700;
      font-weight:800;
      font-size:1.05rem;
      cursor:pointer;
      padding:6px 8px;
      border-radius:10px;
    }
    .back-global svg{width:22px;height:22px}

    .wallet-bar{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      width:100%;
    }
    .wallet-bar .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
    }
    .wallet-bar .connect {background:linear-gradient(135deg,#E5B80B,#FFEA9E);color:#000;border:none}
    .wallet-bar .info {background:rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:12px}

    /* logo */
    .logo{font-family:'Changa One',cursive;font-size:clamp(3.6rem,16vw,6.2rem);font-weight:900;letter-spacing:-3px;text-align:center;margin:8px 0 8px}
    .logo span:first-child{background:linear-gradient(135deg,#FF4500,#DC143C);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 20px #FF4500)}
    .logo span:last-child{background:linear-gradient(135deg,#FFD700,#FFC107);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 25px #FFD700)}

    /* small calculator */
    .calculator{align-self:center;text-align:center;font-weight:700;color:#FFD700;background:rgba(0,0,0,0.45);padding:0.5rem 0.9rem;border-radius:10px;margin:6px auto;font-size:1.4rem;box-shadow:0 6px 16px rgba(255,215,0,0.08);backdrop-filter: blur(4px)}

    #progress{display:flex;justify-content:center;gap:0.7rem;margin:8px 0;font-size:1.6rem;flex-wrap:wrap}

    .step{display:none;padding:12px 0}
    .step.active{display:block}

    .msg{text-align:center;font-size:1.05rem;margin:8px 0;color:#FFD700;font-weight:700}

    /* option-card default */
    .option-card {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px;
      border-radius:16px;
      background:linear-gradient(135deg,#004d40,#006400);
      border:2px solid #FFEA9E;
      color:#fff;
      cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,0.5);
      margin:10px auto;
      width:92%;
      max-width:420px;
      text-align:center;
    }
    .option-card.selected {background:linear-gradient(135deg,#E5B80B,#FFEA9E);color:#000;transform:scale(1.02)}

    /* centered next */
    .centered-next {
      width:220px;height:56px;border-radius:99px;background:linear-gradient(135deg,#E5B80B,#FFEA9E);border:none;color:#000;font-weight:900;font-size:1.1rem;margin:12px auto;display:none;cursor:pointer
    }
    .centered-next.visible{display:block}

    /* date inputs smaller */
    .date-row {display:flex;gap:12px;align-items:center;justify-content:center;margin:14px 0}
    input[type="date"]{
      width:180px;
      height:40px;
      padding:8px 10px;
      border-radius:10px;
      border:2px solid rgba(255,215,0,0.18);
      background:rgba(255,255,255,0.03);
      color:#fff;
      font-size:0.95rem;
    }

    /* parish grid 2 columns */
    #parish-options {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      padding:6px 4px;
    }
    .parish-card {
      background:linear-gradient(135deg,#004d40,#006400);
      border:2px solid #FFEA9E;
      border-radius:14px;
      padding:10px;
      min-height:68px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
    }
    .parish-card:hover{transform:translateY(-4px)}
    .parish-card.selected{background:linear-gradient(135deg,#E5B80B,#FFEA9E);color:#000;box-shadow:0 10px 30px rgba(255,215,0,0.25)}
    .parish-card .pname{font-weight:900;font-size:1rem}
    .parish-card .ptowns{font-size:0.78rem;color:#eee;opacity:0.9;margin-top:6px;line-height:1.1}

    /* smaller controls for counts */
    .small-controls {display:flex;gap:12px;align-items:center;justify-content:center;margin:8px 0}
    .small-controls button{width:40px;height:36px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);color:#FFD700;font-size:1.3rem;cursor:pointer}

    /* summary items */
    #summary-items{margin:10px 6px;border-radius:10px;overflow:hidden}
    #summary-items > div{display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px dashed rgba(255,255,255,0.06)}

    /* QR area */
    #qr-area{margin-top:12px;text-align:center}

    /* hide per-step back buttons to use global one */
    .btn.back{display:none !important}

    /* small responsive tweaks */
    @media (max-width:420px){
      input[type="date"]{width:150px;height:38px}
      .centered-next{width:200px;height:52px}
      .logo{font-size:clamp(3.2rem,18vw,5.2rem)}
    }
  </style>
</head>
<body>
  <div class="overlay"></div>

  <!-- flag and tip -->
  <div class="flag" aria-hidden="true"></div>
  <button id="btnTip" title="Tip (always visible)">ðŸ”¥</button>

  <div class="container">
    <!-- top controls: back + ton connect -->
    <div class="top-controls">
      <div class="top-left">
        <button class="back-global" id="backGlobal" title="Back" style="display:none">
          <svg viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" width="18" height="18" aria-hidden="true"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          Back
        </button>

        <div class="wallet-bar" id="walletTop">
          <button class="btn connect" id="connectWalletBtn">Connect TON Wallet</button>
          <div id="walletInfo" class="info" style="display:none">
            <span id="walletAddr" style="font-weight:800;font-size:0.88rem"></span>
            <button class="btn" id="disconnectWalletBtn" style="margin-left:8px;background:transparent;border:none;color:#FFD700;cursor:pointer">Disconnect</button>
          </div>
        </div>
      </div>
    </div>

    <h1 class="logo"><span>YAAD</span><br><span>VIBE</span></h1>

    <div class="calculator">$<span id="liveTotal">0.00</span></div>
    <div id="progress" aria-hidden="true"></div>

    <!-- Steps -->
    <div id="step0" class="step active">
      <p class="msg">Book Package?</p>
      <div style="text-align:center">
        <button class="centered-next visible" id="startBtn" style="display:inline-block">Start Booking</button>
      </div>
    </div>

    <div id="step1" class="step">
      <p class="msg">Traveling?</p>
      <div class="option-card" data-value="yes"><div class="info">Local</div></div>
      <div class="option-card" data-value="no"><div class="info">Visiting</div></div>
      <button class="centered-next" id="step1Next" onclick="next(2)">Next</button>
    </div>

    <div id="step2" class="step">
      <p class="msg">Where are you departing from?</p>
      <div style="text-align:center;margin:8px 0">
        <select id="fromCity" style="width:86%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,215,0,0.12);color:#fff">
          <option value="">Choose city</option>
          <optgroup label="Jamaica">
            <option value="kingston">Kingston NMIA</option>
            <option value="montego-bay">Montego Bay MBJ</option>
          </optgroup>
          <optgroup label="Foreign">
            <option value="new-york">New York (JFK)</option>
            <option value="miami">Miami (MIA)</option>
            <option value="toronto">Toronto (YYZ)</option>
            <option value="london">London (LHR)</option>
            <option value="atlanta">Atlanta (ATL)</option>
          </optgroup>
        </select>
      </div>
      <div style="text-align:center"><button class="centered-next visible" id="btn2">Next</button></div>
    </div>

    <div id="step25" class="step">
      <p class="msg">Choose a Flight</p>
      <div id="flight-options"></div>
      <div class="option-card" data-flight="skip"><div class="info">Skip</div></div>
      <div style="text-align:center"><button class="centered-next visible" id="btnFlight">Next</button></div>
    </div>

    <div id="step3" class="step">
      <p class="msg">When are you coming?</p>

      <div class="date-row">
        <div style="text-align:center">
          <label style="display:block;color:#FFD700;font-size:0.9rem;margin-bottom:6px">Arrival</label>
          <input type="date" id="arriveDate">
        </div>
        <div style="text-align:center">
          <label style="display:block;color:#FFD700;font-size:0.9rem;margin-bottom:6px">Departure</label>
          <input type="date" id="departDate">
        </div>
      </div>

      <div style="text-align:center;margin:8px 0;font-size:1rem;color:#FFD700;font-weight:700">Nights: <strong><span id="nightCount">1</span></strong></div>

      <div class="small-controls">
        <button id="minus">âˆ’</button>
        <div style="color:#FFD700;font-weight:700">Nights</div>
        <button id="plus">+</button>
      </div>

      <div class="small-controls" style="margin-top:6px;">
        <button id="minusAdult">âˆ’</button>
        <div style="color:#FFD700;font-weight:700">Adults: <strong id="adultCount">1</strong></div>
        <button id="plusAdult">+</button>
      </div>

      <p style="text-align:center;margin:8px 0">Kids: <input type="number" id="kids" value="0" min="0" style="width:80px;height:36px;border-radius:10px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,215,0,0.12);text-align:center;color:#fff"></p>

      <div style="text-align:center"><button class="centered-next visible" id="btn3">Next</button></div>
    </div>

    <div id="step4" class="step">
      <p class="msg">Parish?</p>
      <div id="parish-options" aria-label="Parish options"></div>
      <div style="text-align:center"><button class="centered-next" id="step4Next" onclick="next(5)">Next</button></div>
    </div>

    <div id="step5" class="step">
      <p class="msg">Coastal or Inland?</p>
      <div class="option-card" data-value="coastal"><div class="info">Coastal</div></div>
      <div class="option-card" data-value="inland"><div class="info">Inland</div></div>
      <div style="text-align:center"><button class="centered-next" id="step5Next" onclick="next(6)">Next</button></div>
    </div>

    <div id="step6" class="step">
      <p class="msg">Choose Your Stay</p>
      <div id="stay-options"></div>
      <div style="text-align:center"><button class="centered-next visible" id="btnStay">Next</button></div>
    </div>

    <div id="step7" class="step">
      <p class="msg">Transportation</p>
      <div id="transport-options"></div>
      <div style="text-align:center"><button class="centered-next visible" id="btnTransport">Next</button></div>
    </div>

    <div id="step8" class="step">
      <p class="msg">Tours</p>
      <div id="tour-options"></div>
      <div style="text-align:center"><button class="centered-next visible" id="btnTours">Show My Package</button></div>
    </div>

    <div id="summary" class="step">
      <p class="msg">Your YaadVibe Package</p>
      <div id="summary-items"></div>
      <div class="calculator">Total: $<span id="total">0.00</span></div>
      <div style="text-align:center;margin-top:10px">
        <button class="centered-next visible" id="btnPay">PAY TON WALLET</button>
      </div>
      <div id="qr-area"></div>
    </div>

  </div> <!-- container -->

  <script>
    // -------------------------
    // App data & initial state
    // -------------------------
    document.addEventListener('DOMContentLoaded', () => {

      const PARISH_TOWNS = {
        "clarendon":"May Pen",
        "hanover":"Lucea",
        "kingston":"Kingston",
        "manchester":"Mandeville",
        "portland":"Port Antonio, Hectors River",
        "saint-andrew":"Half Way Tree",
        "saint-ann":"St. Annâ€™s Bay, Ocho Rios, Discovery Bay",
        "saint-catherine":"Spanish Town, Portmore",
        "saint-elizabeth":"Black River",
        "saint-james":"Montego Bay",
        "saint-mary":"Port Maria",
        "saint-thomas":"Morant Bay",
        "trelawny":"Falmouth",
        "westmoreland":"Savanna-la-Mar, Negril West End"
      };

      const LIVE_DATA = {
        flights:{default:[{"airline":"JetBlue","code":"B6231","price":380},{"airline":"American","code":"AA1347","price":420}]},
        accommodations:{default:[{"name":"Sandals Montego Bay","price":320,"img":"/sandals.jpg","type":"coastal"},{"name":"Jakes Hotel","price":280,"img":"/jakes.jpg","type":"coastal"},{"name":"Ian Fleming Villas","price":450,"img":"/ian.jpg","type":"inland"}]},
        transport:{default:[{"name":"Private Transfer","price":80},{"name":"Knutsford Express","price":35}]},
        tours:{default:[{"name":"Dunnâ€™s River","price":65},{"name":"Blue Hole","price":55}]}
      };

      let state = {from:'',arrive:'',depart:'',parish:'',vibe:'',stay:null,transport:[],tours:[],nights:1,adults:1,kids:0,isLocal:false,flight:null};
      let total = 0;
      let currentStep = 0;

      // TonConnect v3 objects
      let tonConnectUI = null;
      let tonConnect = null;
      let connectedAccount = null;

      // UI refs
      const backGlobal = document.getElementById('backGlobal');
      const walletInfo = document.getElementById('walletInfo');
      const walletAddr = document.getElementById('walletAddr');
      const connectWalletBtn = document.getElementById('connectWalletBtn');
      const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');

      // -------------------------
      // Helpers
      // -------------------------
      const updateCalc = () => {
        total = 0;
        if(state.stay){
          const base = state.stay.price * state.nights;
          const extra = (state.adults>2?(state.adults-2)*50:0);
          total += base + extra + Math.round(base*0.05);
        }
        state.transport.forEach(t=> total += t.price);
        state.tours.forEach(t=> total += t.price);
        if(state.flight) total += state.flight.price;
        document.getElementById('liveTotal').textContent = total.toFixed(2);
        const tEl = document.getElementById('total'); if(tEl) tEl.textContent = total.toFixed(2);
      };

      const updateProgress = () => {
        const p = document.getElementById('progress'); p.innerHTML = '';
        const icons = ['ðŸ ','ðŸ§³','âœˆï¸','ðŸ“†','ðŸ—ºï¸','ðŸŽ¢','ðŸ›Œ','ðŸš•','ðŸŽŸï¸','ðŸ›’'];
        const steps = [0,1,2,2.5,3,4,5,6,7,8];
        const currentIndex = steps.indexOf(currentStep);
        icons.forEach((emoji, i) => {
          const span = document.createElement('span');
          span.textContent = emoji;
          span.style.opacity = i <= currentIndex ? '1' : '0.35';
          span.style.cursor = 'pointer';
          span.onclick = (e) => {
            e.stopPropagation();
            if (i > 3 && (!state.arrive || !state.depart)) {
              alert("Please set your arrival & departure dates first");
              next(3); return;
            }
            if (i === 2 && !state.isLocal) next(2.5);
            else if (i === 4) renderParishes();
            else if (i === 6) loadStays();
            else if (i === 7) loadTransport();
            else if (i === 8) loadTours();
            next(steps[i]);
          };
          p.appendChild(span);
        });
      };

      // -------------------------
      // Navigation
      // -------------------------
      window.next = (n) => {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        const id = n === 2.5 ? 'step25' : n === 9 ? 'summary' : `step${n}`;
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.add('active');
        currentStep = n;
        // show/hide global back
        backGlobal.style.display = currentStep > 0 ? 'inline-flex' : 'none';
        updateProgress();
        if(n === 4) renderParishes();
      };

      backGlobal.addEventListener('click', () => {
        const s = [0,1,2,2.5,3,4,5,6,7,8,9];
        const i = s.indexOf(currentStep);
        if(i > 0) next(s[i-1]);
      });

      // -------------------------
      // Parishes (2-column render)
      // -------------------------
      const renderParishes = () => {
        const container = document.getElementById('parish-options');
        container.innerHTML = '';
        // naturalOrder to prioritize major parishes first (as in user's sequence)
        const naturalOrder = ['kingston','saint-andrew','saint-james','saint-ann','portland','saint-catherine','clarendon','manchester','westmoreland','hanover','saint-elizabeth','saint-mary','saint-thomas','trelawny'];
        naturalOrder.forEach(p => {
          const niceName = p.replace(/-/g,' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
          const towns = PARISH_TOWNS[p] || '';
          const card = document.createElement('div');
          card.className = 'parish-card';
          card.dataset.parish = p;
          card.innerHTML = `<div class="pname">${niceName}</div><div class="ptowns">${towns}</div>`;
          card.onclick = () => {
            // single select
            container.querySelectorAll('.parish-card').forEach(c=>c.classList.remove('selected'));
            card.classList.add('selected');
            state.parish = p;
            const btn = document.getElementById('step4Next');
            if(btn) btn.classList.add('visible');
            btn.classList.add('visible');
            btn.style.display = 'inline-block';
          };
          container.appendChild(card);
        });
      };

      // -------------------------
      // Loads for stays / transport / tours / flights
      // -------------------------
      const loadStays = () => {
        const c = document.getElementById('stay-options'); c.innerHTML = '<p style="text-align:center;color:#aaa">Finding your vibe...</p>';
        setTimeout(()=> {
          c.innerHTML = '';
          const items = LIVE_DATA.accommodations.default.filter(i => !state.vibe || i.type === state.vibe);
          items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'option-card';
            card.innerHTML = `<img src="${item.img}" onerror="this.src='/IMG_0039.jpeg'" style="width:64px;height:64px;border-radius:8px;margin-right:10px"><div style="text-align:left"><div style="font-weight:900">${item.name}</div><div style="opacity:0.9;color:#fff">$${item.price}/night</div></div>`;
            card.onclick = () => {
              c.querySelectorAll('.option-card').forEach(x=>x.classList.remove('selected'));
              card.classList.add('selected');
              state.stay = item;
              updateCalc();
            };
            c.appendChild(card);
          });
        }, 500);
      };

      const loadTransport = () => {
        const c = document.getElementById('transport-options'); c.innerHTML = '';
        LIVE_DATA.transport.default.forEach(t => {
          const card = document.createElement('div');
          card.className = 'option-card';
          card.innerHTML = `<div style="text-align:left"><div style="font-weight:900">${t.name}</div><div style="opacity:0.9">$${t.price}</div></div>`;
          card.onclick = () => {
            card.classList.toggle('selected');
            if(card.classList.contains('selected')) state.transport.push(t);
            else state.transport = state.transport.filter(x=>x.name !== t.name);
            updateCalc();
          };
          c.appendChild(card);
        });
      };

      const loadTours = () => {
        const c = document.getElementById('tour-options'); c.innerHTML = '';
        LIVE_DATA.tours.default.forEach(t => {
          const card = document.createElement('div');
          card.className = 'option-card';
          card.innerHTML = `<div style="text-align:left"><div style="font-weight:900">${t.name}</div><div style="opacity:0.9">$${t.price}</div></div>`;
          card.onclick = () => {
            card.classList.toggle('selected');
            if(card.classList.contains('selected')) state.tours.push(t);
            else state.tours = state.tours.filter(x=>x.name !== t.name);
            updateCalc();
          };
          c.appendChild(card);
        });
      };

      const loadFlights = () => {
        const c = document.getElementById('flight-options'); c.innerHTML = '';
        LIVE_DATA.flights.default.forEach(f => {
          const card = document.createElement('div');
          card.className = 'option-card';
          card.innerHTML = `<div style="text-align:left"><div style="font-weight:900">${f.airline} ${f.code}</div><div style="opacity:0.9">$${f.price}</div></div>`;
          card.onclick = () => {
            c.querySelectorAll('.option-card').forEach(x=>x.classList.remove('selected'));
            card.classList.add('selected');
            state.flight = f;
            updateCalc();
          };
          c.appendChild(card);
        });
      };

      // summary builder
      const showSummary = () => {
        const div = document.getElementById('summary-items'); div.innerHTML = '';
        const add = (label,price) => div.innerHTML += `<div><span>${label}</span><strong>$${price}</strong></div>`;
        if(state.stay){
          const base = state.stay.price * state.nights;
          const fee = Math.round(base*0.05);
          add(`${state.stay.name} (${state.nights} nights)`, base);
          add(`Service & Booking Fee`, fee);
        }
        state.transport.forEach(t => add(t.name,t.price));
        state.tours.forEach(t => add(t.name,t.price));
        if(state.flight) add(`${state.flight.airline} Flight`, state.flight.price);
        updateCalc();
        next(9);
      };

      // -------------------------
      // Wire UI events (flow)
      // -------------------------
      document.getElementById('startBtn').addEventListener('click', ()=> next(1));

      // step1 option cards
      document.getElementById('step1').addEventListener('click', e=>{
        const card = e.target.closest('.option-card');
        if(!card) return;
        document.querySelectorAll('#step1 .option-card').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        state.isLocal = card.dataset.value === 'yes';
        document.getElementById('step1Next').classList.add('visible');
      });

      document.getElementById('btn2').addEventListener('click', ()=>{
        state.from = document.getElementById('fromCity').value;
        if(!state.from) { alert('Choose your city!'); return; }
        if(!state.isLocal){ loadFlights(); next(2.5); } else next(3);
      });

      document.getElementById('step25').addEventListener('click', e=>{
        const card = e.target.closest('.option-card');
        if(!card) return;
        document.querySelectorAll('#step25 .option-card').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        if(card.dataset.flight === 'skip') state.flight = null;
        else {
          const txt = card.querySelector('.name') ? card.querySelector('.name').textContent : card.textContent;
          state.flight = LIVE_DATA.flights.default.find(f=> txt.includes(f.airline)) || null;
        }
        updateCalc();
      });
      document.getElementById('btnFlight').addEventListener('click', ()=> next(3));

      // nights/adults toggles
      document.getElementById('minus').addEventListener('click', ()=> { if(state.nights>1){state.nights--; document.getElementById('nightCount').textContent = state.nights; updateCalc(); }});
      document.getElementById('plus').addEventListener('click', ()=> { state.nights++; document.getElementById('nightCount').textContent = state.nights; updateCalc(); });
      document.getElementById('minusAdult').addEventListener('click', ()=> { if(state.adults>1){state.adults--; document.getElementById('adultCount').textContent = state.adults; updateCalc(); }});
      document.getElementById('plusAdult').addEventListener('click', ()=> { state.adults++; document.getElementById('adultCount').textContent = state.adults; updateCalc(); });
      document.getElementById('kids').addEventListener('change', e=> { state.kids = +e.target.value; updateCalc(); });

      document.getElementById('btn3').addEventListener('click', ()=>{
        state.arrive = document.getElementById('arriveDate').value;
        state.depart = document.getElementById('departDate').value;
        if(!state.arrive || !state.depart){ alert('Please select both dates'); return; }
        const arrive = new Date(state.arrive), depart = new Date(state.depart);
        if(depart <= arrive){ alert('Departure must be after arrival'); return; }
        const nights = Math.floor((depart - arrive) / (1000*60*60*24));
        if(nights < 1 || nights > 90){ alert('Stay between 1 and 90 nights'); return; }
        state.nights = nights; document.getElementById('nightCount').textContent = nights; updateCalc();
        next(4);
      });

      // step5 vibe
      document.getElementById('step5').addEventListener('click', e=>{
        const card = e.target.closest('.option-card');
        if(!card) return;
        document.querySelectorAll('#step5 .option-card').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        state.vibe = card.dataset.value;
        document.getElementById('step5Next').classList.add('visible');
      });

      document.getElementById('btnStay').addEventListener('click', ()=> { if(!state.stay) { alert('Choose your stay!'); return; } loadTransport(); next(7); });
      document.getElementById('btnTransport').addEventListener('click', ()=> { loadTours(); next(8); });
      document.getElementById('btnTours').addEventListener('click', showSummary);

      // update nights on date change
      ['arriveDate','departDate'].forEach(id => {
        document.getElementById(id).addEventListener('change', ()=> {
          const a = document.getElementById('arriveDate').value;
          const d = document.getElementById('departDate').value;
          if(a && d){
            const nights = Math.floor((new Date(d) - new Date(a)) / 86400000);
            if(nights > 0 && nights <= 90){ state.nights = nights; document.getElementById('nightCount').textContent = nights; updateCalc(); }
          }
        });
      });

      // show next button when option card tapped
      document.addEventListener('click', e=>{
        if(e.target.closest('.option-card')){
          const step = e.target.closest('.step'); if(!step) return;
          const btn = step.querySelector('.centered-next'); if(btn) btn.classList.add('visible');
        }
      });

      // initialize UI
      updateProgress(); updateCalc();

      // -------------------------
      // TonConnect v3 integration (basic)
      // -------------------------
      try {
        const TonConnectUI = window.TonConnectUI?.TonConnectUI || window.TonConnectUI;
        const TonConnect = window.TonConnect?.TonConnect || window.TonConnect;
        if(TonConnect && TonConnectUI){
          tonConnect = new TonConnect();
          tonConnectUI = new TonConnectUI({ manifestUrl: '' });

          // status change
          tonConnect.onStatusChange((wallet) => {
            connectedAccount = wallet;
            refreshWalletUI();
          });

          // connect button
          connectWalletBtn.addEventListener('click', async ()=>{
            try {
              await tonConnectUI.connect();
              // after connect, onStatusChange should fire; otherwise, try to read tonConnect.account
              if(tonConnect && tonConnect.account) { connectedAccount = tonConnect.account; refreshWalletUI(); }
            } catch(err){
              console.error('connect error', err);
              alert('Wallet connect failed: ' + (err.message || err));
            }
          });

          // disconnect
          disconnectWalletBtn.addEventListener('click', async ()=>{
            try {
              await tonConnect.disconnect();
              connectedAccount = null;
              refreshWalletUI();
            } catch(err){
              console.error('disconnect err', err);
            }
          });
        } else {
          console.warn('TonConnect UI/SDK not found (CDN).');
        }
      } catch(err){
        console.error('TonConnect init error', err);
      }

      function refreshWalletUI(){
        let acc = null;
        try { acc = (tonConnect && tonConnect.account) ? tonConnect.account : connectedAccount; } catch(e){ acc = connectedAccount; }
        if(acc && acc.account){
          connectWalletBtn.style.display = 'none';
          walletInfo.style.display = 'inline-flex';
          walletAddr.textContent = acc.account;
        } else {
          connectWalletBtn.style.display = 'inline-flex';
          walletInfo.style.display = 'none';
          walletAddr.textContent = '';
        }
      }

      // -------------------------
      // Payment: TON transfer + QR fallback
      // -------------------------
      document.getElementById('btnPay').addEventListener('click', async ()=>{
        updateCalc();
        if(total <= 0){ alert('Your total is $0. Add items to pay.'); return; }

        // Put your real receiving TON address here:
        const MERCHANT_ADDRESS = 'EQCXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'; // <- REPLACE

        if(!MERCHANT_ADDRESS || MERCHANT_ADDRESS.startsWith('EQCXXXX')) {
          alert('Merchant TON address not configured. Replace MERCHANT_ADDRESS in the code.');
        }

        // TODO: fetch a real USD->TON exchange rate server-side; for demo we keep 1:1
        const exchangeRateTONperUSD = 1.0;
        const amountTON = (total * exchangeRateTONperUSD).toFixed(4);
        const memo = encodeURIComponent(`YaadVibe booking - ${new Date().toISOString().slice(0,10)}`);
        const tonUri = `ton://transfer/${MERCHANT_ADDRESS}?amount=${amountTON}&text=${memo}`;

        const qrArea = document.getElementById('qr-area'); qrArea.innerHTML = '';

        // If TonConnect available and connected, prefer prompt sendTransaction via SDK
        if(tonConnect && tonConnect.account){
          const useSdk = confirm('Wallet connected. Click OK to request the connected wallet to send the TON payment. Cancel to show QR code.');
          if(useSdk){
            try {
              // TonConnect v3 expects messages in a certain shape; this is a common pattern.
              // Many wallets accept nanotons (1 TON = 1e9 nanotons). Convert to nanotons:
              const amountNano = (Number(amountTON) * 1e9).toFixed(0); // integer string
              const tx = {
                validUntil: Math.floor(Date.now()/1000) + 60*5,
                messages: [
                  { to: MERCHANT_ADDRESS, amount: amountNano }
                ]
              };
              const res = await tonConnect.sendTransaction(tx);
              console.log('sendTransaction res', res);
              alert('Transaction request sent to your wallet. Confirm in the wallet app.');
              return;
            } catch(err){
              console.error('sendTransaction failed', err);
              alert('Wallet transaction request failed: ' + (err.message || err));
              // fall through to QR fallback
            }
          }
        }

        // QR fallback + deep link
        const title = document.createElement('div'); title.style.color='#FFD700'; title.style.marginBottom='8px';
        title.textContent = `Scan to pay ${amountTON} TON`;
        qrArea.appendChild(title);

        const qrDiv = document.createElement('div'); qrArea.appendChild(qrDiv);
        new QRCode(qrDiv, { text: tonUri, width:220, height:220 });

        const linkRow = document.createElement('div'); linkRow.style.marginTop='12px'; linkRow.style.display='flex'; linkRow.style.gap='10px'; linkRow.style.justifyContent='center';
        const openBtn = document.createElement('a'); openBtn.className='btn connect'; openBtn.textContent='Open wallet (mobile)'; openBtn.href = tonUri; openBtn.style.textDecoration='none';
        const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='Copy transfer link';
        copyBtn.onclick = () => navigator.clipboard.writeText(tonUri).then(()=> alert('Copied transfer link'));
        linkRow.appendChild(openBtn); linkRow.appendChild(copyBtn);
        qrArea.appendChild(linkRow);

      });

      // refresh wallet UI periodically (in case status changes)
      setInterval(()=> { try { refreshWalletUI(); } catch(e){} }, 2500);

      // initial render of parishes (so grid exists when user arrives)
      renderParishes();
    });
  </script>
</body>
</html>
